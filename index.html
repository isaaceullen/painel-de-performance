<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Camerite — Dashboard (Dark)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0c0a14;--bg-soft:#151026;--bg-softer:#1e1640;--text:#f2edff;--muted:#bfb6db;
      --brand:#7b48ea;--brand-2:#d3c2f8;--brand-3:#29184e;
      --line:#2a214a;--chip:#241b48;--ok:#34d399;--warn:#f59e0b;--err:#ef4444;
      --radius:14px;--radius-lg:18px;--shadow:0 8px 24px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(123,72,234,.15), transparent 45%),
        radial-gradient(900px 600px at 110% 0%, rgba(211,194,248,.12), transparent 45%),
        var(--bg);
      color:var(--text);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      overflow-x:hidden; /* apenas scroll vertical */
      line-height:1.35
    }
    a{color:var(--brand)}
    .container{max-width:1224px;margin:0 auto;padding:100px 18px 28px}

    /* Appbar fixo */
    .appbar{position:sticky;top:0;z-index:50;background:rgba(12,10,20,.72);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .appbar .inner{max-width:1224px;margin:0 auto;padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 0 0 4px rgba(123,72,234,.18)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .select,.button,.input,.toggle{background:var(--bg-softer);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;font-size:.95rem;outline:none}
    .button{cursor:pointer}
    .toggle{display:flex;gap:6px;align-items:center}
    .toggle input{accent-color:var(--brand)}

    /* Seg tabs */
    .seg-tabs{display:flex;gap:8px;flex-wrap:wrap;margin: 10px 0 16px}
    .seg-tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:var(--chip);cursor:pointer;user-select:none}
    .seg-tab.active{background:linear-gradient(135deg,var(--brand-3),var(--bg-softer));border-color:#3b2a73;box-shadow:inset 0 0 0 1px rgba(211,194,248,.16)}

    /* Cards / grids */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    @media (max-width: 980px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}}
    .card{background:var(--bg-soft);border:1px solid var(--line);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px;font-size:1.05rem}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:10px 0 12px}
    .section-title h2{margin:0;font-size:1.2rem}
    .note{color:var(--muted);font-size:.85rem}

    /* Tabela semanas fixas */
    .wk{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .wk thead th{background:linear-gradient(180deg,#221a42,#1b1435);position:sticky;top:0;border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;font-weight:600}
    .wk tbody td{border-bottom:1px solid var(--line);padding:6px 8px;vertical-align:middle}
    .row-label{white-space:nowrap;color:var(--muted)}
    .num{width:100%;max-width:120px;background:var(--bg-softer);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px 10px;font-variant-numeric:tabular-nums}

    /* Pills */
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);color:var(--text);border-radius:999px;padding:6px 10px;font-size:.9rem}
    .pill .x{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#3a2c74;cursor:pointer;font-weight:700}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn-sm{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:var(--bg-softer);color:var(--text);cursor:pointer;font-size:.85rem}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:#5f35c4}
    .mode{font-size:.78rem;color:var(--muted);padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}

    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{min-width:160px;flex:1;background:linear-gradient(180deg,#1a1238,#130d29);border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .v{font-weight:700;font-size:1.1rem}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="appbar">
    <div class="inner">
      <div class="brand"><span class="dot"></span> Camerite — Dashboard</div>
      <div class="toolbar">
        <select id="yearSelect" class="select" title="Ano">
          <option>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
        </select>
        <select id="monthSelect" class="select" title="Mês">
          <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option><option value="3">Abril</option>
          <option value="4">Maio</option><option value="5">Junho</option><option value="6">Julho</option><option value="7">Agosto</option>
          <option value="8">Setembro</option><option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
        </select>
        <label class="toggle"><input id="modeToggle" type="checkbox"/> <span>Ver anual (mês a mês)</span></label>
        <button id="importBtn" class="button">Importar JSON</button>
        <button id="exportBtn" class="button btn-primary">Exportar JSON</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- SEGMENTOS -->
    <div class="section-title">
      <h2>Segmento</h2>
      <span class="note">5 semanas fixas • Se o mês importado vier com <b>weeks = 0</b>, nada é exibido.</span>
    </div>
    <div class="seg-tabs" id="segTabs">
      <div class="seg-tab active" data-seg="Franquias">Franquias</div>
      <div class="seg-tab" data-seg="White Label">White Label</div>
      <div class="seg-tab" data-seg="Redes Sociais">Redes Sociais</div>
    </div>

    <!-- ======= KPI RESUMO (Franquias / White Label) ======= -->
    <div id="kpiBar" class="grid" style="margin-bottom:10px">
      <div class="card col-12">
        <div class="kpis">
          <div class="kpi"><div class="note">Investimento Total (Mês)</div><div id="kpiInvest" class="v">R$ 0,00</div></div>
          <div class="kpi"><div class="note">Leads (Mês)</div><div id="kpiLeads" class="v">0</div></div>
          <div class="kpi"><div class="note">Oportunidades (Mês)</div><div id="kpiOpp" class="v">0</div></div>
          <div class="kpi"><div class="note">Vendas (Mês)</div><div id="kpiSales" class="v">0</div></div>
          <div class="kpi"><div class="note">CAC Médio (Mês)</div><div id="kpiCAC" class="v">R$ 0,00</div></div>
        </div>
      </div>
    </div>

    <!-- ===================== INPUTS — FRANQUIAS / WHITE LABEL ===================== -->
    <div id="fwArea">

      <!-- ORGÂNICO -->
      <div class="section-title"><h2>Orgânico</h2><span class="note">Gerencie as fontes e Landing Pages (leads por semana).</span></div>

      <div class="grid">
        <!-- Origens de Tráfego -->
        <div class="card col-6">
          <h3>Origens de Tráfego</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="orgNewSource" class="input" placeholder="Nova origem (ex.: Google, Bing, Site)"/>
            <button id="btnAddSource" class="btn-sm">Adicionar origem</button>
          </div>
          <div id="orgSourceList" class="row"></div>
          <div id="orgSourceTables"></div>
        </div>

        <!-- Landing Pages -->
        <div class="card col-6">
          <h3>Landing Pages</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="lpNew" class="input" placeholder="Nova LP (ex.: LP Segurança Bairro)"/>
            <button id="btnAddLP" class="btn-sm">Adicionar LP</button>
          </div>
          <div id="lpList" class="row"></div>
          <div id="lpTables"></div>
        </div>
      </div>

      <!-- PAGO -->
      <div class="section-title" style="margin-top:18px"><h2>Pago</h2><span class="note">Meta Ads e Google Ads — com Leads Planejados e Conquistados.</span></div>
      <div class="grid">
        <div class="card col-12">
          <h3>Meta Ads</h3>
          <table class="wk" id="tblMeta">
            <thead>
              <tr><th>Métrica</th><th>Semana 1</th><th>Semana 2</th><th>Semana 3</th><th>Semana 4</th><th>Semana 5</th><th>Total</th></tr>
            </thead>
            <tbody>
              <tr data-m="investimento"><td class="row-label">Investimento (R$)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="alcance"><td class="row-label">Alcance</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="impressoes"><td class="row-label">Impressões</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="cliques"><td class="row-label">Cliques</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="ctr"><td class="row-label">CTR (%)</td>
                <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td class="total"></td></tr>
              <tr data-m="sessoes"><td class="row-label">Sessões</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="leadsPlan"><td class="row-label">Leads (Planejados)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="leads"><td class="row-label">Leads (Conquistados)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            </tbody>
          </table>
        </div>

        <div class="card col-12">
          <h3>Google Ads</h3>
          <table class="wk" id="tblGoogle">
            <thead>
              <tr><th>Métrica</th><th>Semana 1</th><th>Semana 2</th><th>Semana 3</th><th>Semana 4</th><th>Semana 5</th><th>Total</th></tr>
            </thead>
            <tbody>
              <tr data-m="investimento"><td class="row-label">Investimento (R$)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="alcance"><td class="row-label">Alcance</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="impressoes"><td class="row-label">Impressões</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="cliques"><td class="row-label">Cliques</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="ctr"><td class="row-label">CTR (%)</td>
                <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td class="total"></td></tr>
              <tr data-m="sessoes"><td class="row-label">Sessões</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="leadsPlan"><td class="row-label">Leads (Planejados)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
              <tr data-m="leads"><td class="row-label">Leads (Conquistados)</td>
                <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PIPELINE COMERCIAL -->
      <div class="section-title" style="margin-top:18px"><h2>Pipeline Comercial</h2><span class="note">Leads é preenchido automaticamente (orgânico + pago). CAC semanal e mensal.</span></div>
      <div class="card col-12">
        <table class="wk" id="tblPipe">
          <thead>
            <tr><th>Etapa</th><th>Semana 1</th><th>Semana 2</th><th>Semana 3</th><th>Semana 4</th><th>Semana 5</th><th>Total</th></tr>
          </thead>
          <tbody>
            <tr data-m="leads"><td class="row-label">Leads (auto)</td>
              <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td class="total"></td></tr>
            <tr data-m="oportunidades"><td class="row-label">Oportunidades</td>
              <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            <tr data-m="noShow"><td class="row-label">No Show</td>
              <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            <tr data-m="perdidos"><td class="row-label">Perdidos</td>
              <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            <tr data-m="vendas"><td class="row-label">Vendas</td>
              <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td><td class="total"></td></tr>
            <tr data-m="cpo"><td class="row-label">CPO (R$) <span class="note">Invest. total ÷ Oportunidades</span></td>
              <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td class="total"></td></tr>
            <tr data-m="cac"><td class="row-label">CAC (R$) <span class="note">Invest. total ÷ Oportunidades</span></td>
              <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td class="total"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===================== REDES SOCIAIS ===================== -->
    <div id="socialArea" style="display:none">
      <div class="section-title"><h2>Redes Sociais</h2><span class="note">Adicione/exclua redes e métricas. Sem CPO/CPL aqui.</span></div>

      <div class="card col-12" style="margin-bottom:12px">
        <div class="row" style="margin-bottom:8px">
          <input id="newNetwork" class="input" placeholder="Nova rede (ex.: Instagram)"/>
          <button id="btnAddNetwork" class="btn-sm">Adicionar rede</button>
        </div>
        <div id="networkPills" class="row" style="margin-bottom:8px"></div>

        <div class="row" style="margin-bottom:8px">
          <input id="newMetric" class="input" placeholder="Nova métrica (ex.: Engajamentos)"/>
          <button id="btnAddMetric" class="btn-sm">Adicionar métrica</button>
        </div>
        <div id="metricPills" class="row" style="margin-bottom:8px"></div>
      </div>

      <div id="socialTables" class="grid"></div>

      <div class="section-title" style="margin-top:18px">
        <h2>Dashboard — Social</h2>
        <span class="mode">Semanal (5 semanas)</span>
      </div>
      <div class="card col-12">
        <div class="row" style="margin-bottom:8px">
          <select id="selNet" class="select"></select>
          <select id="selMetric" class="select"></select>
        </div>
        <canvas id="chartSocial" height="120"></canvas>
      </div>
    </div>

    <!-- ===================== DASHBOARDS (Franquias/White Label) ===================== -->
    <div id="dashArea">
      <div class="section-title" style="margin-top:18px">
        <h2>Dashboards</h2>
        <span class="mode">Semanal por padrão • Alterne para anual no topo</span>
      </div>

      <!-- Semanais -->
      <div id="weeklyDash" class="grid">
        <div class="card col-6">
          <div class="row" style="justify-content:space-between">
            <h3>Investimento semanal — Meta + Google</h3>
            <select id="investView" class="select" title="Visão">
              <option value="total">Total (Meta+Google)</option>
              <option value="separado">Separado</option>
              <option value="meta">Apenas Meta</option>
              <option value="google">Apenas Google</option>
            </select>
          </div>
          <canvas id="chartInvest" height="120"></canvas>
          <div class="note">Soma exata dos inputs semanais (sanitização BR: 9.000 ⇒ 9000).</div>
        </div>

        <div class="card col-6">
          <h3>CPL semanal (pago)</h3>
          <canvas id="chartCPL" height="120"></canvas>
          <div class="note">CPL = Investimento (Meta+Google) ÷ Leads (pago).</div>
        </div>

        <div class="card col-6">
          <h3>CPO semanal</h3>
          <canvas id="chartCPO" height="120"></canvas>
          <div class="note">CPO = Investimento (Meta+Google) ÷ Oportunidades.</div>
        </div>

        <div class="card col-6">
          <h3>Lead × Oportunidade (semanal)</h3>
          <canvas id="chartLeadOpp" height="120"></canvas>
        </div>

        <div class="card col-12">
          <div class="row" style="justify-content:space-between">
            <h3>Leads Planejados × Conquistados (semanal)</h3>
            <select id="leadPlanView" class="select">
              <option value="ambos">Ambos os canais</option>
              <option value="meta">Somente Meta</option>
              <option value="google">Somente Google</option>
            </select>
          </div>
          <canvas id="chartLeadPlan" height="120"></canvas>
        </div>

        <div class="card col-12">
          <h3>Awareness & Engajamento — Totais Semanais (pago)</h3>
          <canvas id="chartAware" height="120"></canvas>
          <div class="note">Alcance, Impressões, Cliques, Sessões (Meta+Google). CTR em eixo secundário.</div>
        </div>
      </div>

      <!-- Anual -->
      <div id="annualDash" style="display:none">
        <div class="card col-12">
          <h3>Evolução anual: Awareness (Alcance) → Cliques → Leads → Oportunidade → Vendas</h3>
          <canvas id="chartAnnual" height="140"></canvas>
        </div>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none"/>

  <script>
    /* ========================= UTIL ========================= */
    const YEARS=[2025,2026,2027,2028,2029,2030];
    const MONTHS=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    const SEGMENTS=["Franquias","White Label","Redes Sociais"];
    const zeros5=()=>[0,0,0,0,0];
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    const sum=arr=>arr.reduce((a,b)=>a+num(b),0);
    const fmtR=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const weekLabels=()=>["W1","W2","W3","W4","W5"];
    const calcCTR=(c,imp)=>imp>0?(c/imp)*100:0;

    // sanitiza valor BR: "9.000,50" => 9000.50 | "9.000" => 9000
    function parseBRNumber(text){
      if (text == null) return 0;
      let s = (""+text).replace(/[^\d.,-]/g,''); // keep digits , . -
      // remove milhares
      s = s.replace(/\.(?=\d{3}(\D|$))/g,'');
      // vírgula decimal -> ponto
      s = s.replace(',', '.');
      const v = parseFloat(s);
      return isNaN(v)?0:v;
    }
    const num=parseBRNumber;

    /* ========================= ESTADO ======================= */
    function defaultFWMonth(){
      return{
        weeks:5,
        organic:{
          sources:{ "Google":zeros5(), "Bing":zeros5(), "Site":zeros5() }, // leads por semana
          landing:{ "LP Principal":zeros5() }
        },
        paid:{
          meta:{ investimento:zeros5(), alcance:zeros5(), impressoes:zeros5(), cliques:zeros5(), sessoes:zeros5(), leadsPlan:zeros5(), leads:zeros5() },
          google:{ investimento:zeros5(), alcance:zeros5(), impressoes:zeros5(), cliques:zeros5(), sessoes:zeros5(), leadsPlan:zeros5(), leads:zeros5() }
        },
        pipe:{ leads:zeros5(), oportunidades:zeros5(), noShow:zeros5(), perdidos:zeros5(), vendas:zeros5(), cpo:zeros5(), cac:zeros5() }
      }
    }
    function defaultSocialMonth(){
      return{
        weeks:5,
        metrics:["Alcance","Impressões","Cliques","Sessões"],
        networks:{
          "Instagram":{ "Alcance":zeros5(),"Impressões":zeros5(),"Cliques":zeros5(),"Sessões":zeros5() },
          "Facebook":{ "Alcance":zeros5(),"Impressões":zeros5(),"Cliques":zeros5(),"Sessões":zeros5() }
        }
      }
    }

    const STATE={
      year:YEARS[0],
      month:0,
      segment:"Franquias",
      mode:"weekly",
      data:{
        "Franquias": Object.fromEntries(YEARS.map(y=>[y,Array.from({length:12},defaultFWMonth)])),
        "White Label": Object.fromEntries(YEARS.map(y=>[y,Array.from({length:12},defaultFWMonth)])),
        "Redes Sociais": Object.fromEntries(YEARS.map(y=>[y,Array.from({length:12},defaultSocialMonth)]))
      }
    };

    function curData(){ return STATE.data[STATE.segment][STATE.year][STATE.month]; }
    function monthEnabled(){ return curData().weeks!==0; }

    /* ========================= INIT: mês atual ======================= */
    (function initCurrentYearMonth(){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth(); // 0..11
      if (YEARS.includes(y)) {
        STATE.year = y;
        $("#yearSelect").value = String(y);
      }
      STATE.month = m;
      $("#monthSelect").value = String(m);
    })();

    /* ========================= SEGMENTOS ====================== */
    $("#segTabs").addEventListener('click',e=>{
      const t=e.target.closest('.seg-tab'); if(!t) return;
      $$(".seg-tab").forEach(x=>x.classList.remove('active')); t.classList.add('active');
      STATE.segment=t.dataset.seg;
      toggleAreas();
      renderAll();
    });

    function toggleAreas(){
      const social=STATE.segment==="Redes Sociais";
      $("#fwArea").style.display = social?"none":"";
      $("#dashArea").style.display = social?"none":"";   // dashboards só para F/W
      $("#kpiBar").style.display = social?"none":"";
      $("#socialArea").style.display = social?"":"none";
    }

    /* ========================= ORGÂNICO (F/W) ================= */
    function table5(id,label){
      let t = `<table class="wk" data-bind="${id}">
        <thead><tr><th>${label}</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>Total</th></tr></thead>
        <tbody><tr>`;
      t+=`<td class="row-label">Leads</td>`;
      for(let i=0;i<5;i++){ t+=`<td><input class="num" data-w="${i}"/></td>`; }
      t+=`<td class="total"></td></tr></tbody></table>`;
      return t;
    }
    function updateRowTotal(tbl){
      const inputs=[...tbl.querySelectorAll("input.num[data-w]")];
      const vals=inputs.map(i=>num(i.value));
      const total=tbl.querySelector(".total");
      total.textContent=sum(vals).toLocaleString('pt-BR');
    }

    function renderOrganic(){
      const m=curData(); if(!m) return;
      // Origens
      const list=$("#orgSourceList"); list.innerHTML="";
      const tables=$("#orgSourceTables"); tables.innerHTML="";
      Object.keys(m.organic.sources).forEach(src=>{
        const pill=document.createElement('div');
        pill.className="pill"; pill.innerHTML=`<span>${src}</span><span class="x" title="Remover" data-src="${src}">×</span>`;
        list.appendChild(pill);

        const wrap=document.createElement('div');
        wrap.style.marginTop="8px";
        wrap.innerHTML=table5(`org-src-${src}`,"Leads — "+src);
        tables.appendChild(wrap);

        const tbl=wrap.querySelector("table");
        // preencher
        const arr=m.organic.sources[src];
        [...tbl.querySelectorAll("input.num[data-w]")].forEach(inp=>{
          const i=+inp.dataset.w;
          inp.value=arr[i]??0;
        });
        updateRowTotal(tbl);
      });
      list.onclick=e=>{
        const x=e.target.closest('.x'); if(!x) return;
        delete m.organic.sources[x.dataset.src];
        renderOrganic(); renderPipe(); renderChartsAndKpis();
      };
      $("#btnAddSource").onclick=()=>{
        const name=$("#orgNewSource").value.trim(); if(!name) return;
        if(!m.organic.sources[name]) m.organic.sources[name]=zeros5();
        $("#orgNewSource").value="";
        renderOrganic(); renderPipe(); renderChartsAndKpis();
      };

      // LPs
      const lpList=$("#lpList"); lpList.innerHTML="";
      const lpTables=$("#lpTables"); lpTables.innerHTML="";
      Object.keys(m.organic.landing).forEach(lp=>{
        const pill=document.createElement('div');
        pill.className="pill"; pill.innerHTML=`<span>${lp}</span><span class="x" title="Remover" data-lp="${lp}">×</span>`;
        lpList.appendChild(pill);

        const wrap=document.createElement('div');
        wrap.style.marginTop="8px";
        wrap.innerHTML=table5(`org-lp-${lp}`,"Leads — "+lp);
        lpTables.appendChild(wrap);

        const tbl=wrap.querySelector("table");
        const arr=m.organic.landing[lp];
        [...tbl.querySelectorAll("input.num[data-w]")].forEach(inp=>{
          const i=+inp.dataset.w;
          inp.value=arr[i]??0;
        });
        updateRowTotal(tbl);
      });
      lpList.onclick=e=>{
        const x=e.target.closest('.x'); if(!x) return;
        delete m.organic.landing[x.dataset.lp];
        renderOrganic(); renderPipe(); renderChartsAndKpis();
      };
      $("#btnAddLP").onclick=()=>{
        const name=$("#lpNew").value.trim(); if(!name) return;
        if(!m.organic.landing[name]) m.organic.landing[name]=zeros5();
        $("#lpNew").value="";
        renderOrganic(); renderPipe(); renderChartsAndKpis();
      };

      // Delegação de input (corrige perder foco / rebind por mês)
      $("#orgSourceTables").oninput = e=>{
        const inp=e.target.closest("input.num[data-w]"); if(!inp) return;
        const tbl=inp.closest("table"); const id=tbl.dataset.bind; const i=+inp.dataset.w;
        const v=num(inp.value);
        const mth=curData();
        if(id.startsWith("org-src-")){
          const key=id.replace("org-src-","");
          if(!mth.organic.sources[key]) mth.organic.sources[key]=zeros5();
          mth.organic.sources[key][i]=v;
        }else{
          const key=id.replace("org-lp-","");
          if(!mth.organic.landing[key]) mth.organic.landing[key]=zeros5();
          mth.organic.landing[key][i]=v;
        }
        updateRowTotal(tbl);
        renderPipe(); renderChartsAndKpis(false);
      };
      $("#lpTables").oninput = $("#orgSourceTables").oninput;
    }

    /* ========================= PAGO (F/W) ===================== */
    function fillPaidTable(tbl,obj){
      // preencher valores e totais
      tbl.querySelectorAll("tbody tr").forEach(tr=>{
        const metric=tr.dataset.m;
        const inputs=[...tr.querySelectorAll("input.num")];
        if(metric==="ctr"){
          for(let i=0;i<5;i++){
            const c=num(obj.cliques[i]); const im=num(obj.impressoes[i]);
            inputs[i].value=calcCTR(c,im).toFixed(2);
          }
          tr.querySelector(".total").textContent=(Array.from({length:5},(_,i)=>calcCTR(num(obj.cliques[i]),num(obj.impressoes[i]))).reduce((a,b)=>a+b,0)/5).toFixed(2)+" %";
        }else{
          inputs.forEach((inp,i)=> inp.value = obj[metric][i] ?? 0 );
          tr.querySelector(".total").textContent=sum(obj[metric]).toLocaleString('pt-BR');
        }
      });
    }
    function renderPaid(){
      const m=curData();
      fillPaidTable($("#tblMeta"), m.paid.meta);
      fillPaidTable($("#tblGoogle"), m.paid.google);
    }

    // Delegação de input para tabelas pagas (funciona em qualquer mês)
    ["#tblMeta","#tblGoogle"].forEach(sel=>{
      const tbl = $(sel);
      tbl.addEventListener('input', e=>{
        const inp=e.target.closest("input.num"); if(!inp) return;
        const tr=inp.closest("tr"); const metric=tr.dataset.m;
        if(metric==="ctr") return; // calculado
        const i = inp.dataset.w ? +inp.dataset.w : Array.from(inp.parentElement.parentElement.children).indexOf(inp.parentElement)-1;
        const v = num(inp.value);
        const mth=curData();
        const obj = (sel==="#tblMeta") ? mth.paid.meta : mth.paid.google;
        obj[metric][i] = v;
        // atualizar CTR e totais
        fillPaidTable(tbl, obj);
        renderPipe(); renderChartsAndKpis();
      });
    });

    /* ========================= PIPELINE (F/W) ================= */
    function computeAutoLeads(m){
      const orgW=[0,0,0,0,0];
      Object.values(m.organic.sources).forEach(a=>a.forEach((v,i)=>orgW[i]+=num(v)));
      Object.values(m.organic.landing).forEach(a=>a.forEach((v,i)=>orgW[i]+=num(v)));
      const paidW=[0,0,0,0,0];
      for(let i=0;i<5;i++) paidW[i]=num(m.paid.meta.leads[i])+num(m.paid.google.leads[i]);
      return orgW.map((v,i)=>v+paidW[i]);
    }
    function recomputePipeDerived(m){
      m.pipe.leads = computeAutoLeads(m);
      const invW=[0,0,0,0,0];
      for(let i=0;i<5;i++) invW[i]=num(m.paid.meta.investimento[i])+num(m.paid.google.investimento[i]);
      for(let i=0;i<5;i++){
        const opp=num(m.pipe.oportunidades[i]);
        const c=(opp>0)? invW[i]/opp : 0;
        m.pipe.cpo[i]=c; m.pipe.cac[i]=c;
      }
    }
    function fillPipeTable(){
      const m=curData();
      recomputePipeDerived(m);
      const tbl=$("#tblPipe");
      tbl.querySelectorAll("tbody tr").forEach(tr=>{
        const k=tr.dataset.m;
        const inputs=[...tr.querySelectorAll("input.num")];
        const arr=m.pipe[k];
        inputs.forEach((inp,i)=>{
          inp.value = (k==="leads"||k==="cpo"||k==="cac") ? (k==="leads"? arr[i] : (arr[i]??0).toFixed(2)) : (arr[i]??0);
        });
        tr.querySelector(".total").textContent=(k==="cpo"||k==="cac")? (sum(arr)/5).toFixed(2) : sum(arr).toLocaleString('pt-BR');
      });
    }
    $("#tblPipe").addEventListener('input', e=>{
      const inp=e.target.closest("input.num[data-w]"); if(!inp) return;
      const m=curData();
      const tr=inp.closest("tr"); const k=tr.dataset.m; if(["leads","cpo","cac"].includes(k)) return;
      const i=+inp.dataset.w; m.pipe[k][i]=num(inp.value);
      fillPipeTable(); renderChartsAndKpis();
    });

    /* ========================= SOCIAL ========================= */
    function renderSocial(){
      const s=curData(); // social month
      // redes (pills)
      const pills=$("#networkPills"); pills.innerHTML="";
      Object.keys(s.networks).forEach(n=>{
        const pill=document.createElement('div');
        pill.className="pill"; pill.innerHTML=`<span>${n}</span><span class="x" data-net="${n}">×</span>`;
        pills.appendChild(pill);
      });
      pills.onclick=e=>{
        const x=e.target.closest('.x'); if(!x) return;
        delete s.networks[x.dataset.net];
        renderSocialTables();
        renderSocialSelectors();
        renderSocialChart();
      };
      $("#btnAddNetwork").onclick=()=>{
        const name=$("#newNetwork").value.trim(); if(!name) return;
        if(!s.networks[name]) s.networks[name]=Object.fromEntries(s.metrics.map(mm=>[mm,zeros5()]));
        $("#newNetwork").value="";
        renderSocialTables(); renderSocialSelectors(); renderSocialChart();
      };

      // métricas (pills c/ remover)
      renderMetricPills();
      $("#btnAddMetric").onclick=()=>{
        const mname=$("#newMetric").value.trim(); if(!mname) return;
        if(!s.metrics.includes(mname)){
          s.metrics.push(mname);
          Object.values(s.networks).forEach(obj=> obj[mname]=zeros5());
        }
        $("#newMetric").value="";
        renderMetricPills(); renderSocialTables(); renderSocialSelectors(); renderSocialChart();
      };

      renderSocialTables();
      renderSocialSelectors();
      renderSocialChart();
    }
    function renderMetricPills(){
      const s=curData();
      const holder=$("#metricPills"); holder.innerHTML="";
      s.metrics.forEach(mm=>{
        const pill=document.createElement('div');
        pill.className="pill"; pill.innerHTML=`<span>${mm}</span><span class="x" data-m="${mm}">×</span>`;
        holder.appendChild(pill);
      });
      holder.onclick=e=>{
        const x=e.target.closest('.x'); if(!x) return;
        const rm=x.dataset.m;
        // remover métrica (sem permitir remover CTR que é derivado)
        if(["CTR","CTR (%)"].includes(rm)) return;
        s.metrics = s.metrics.filter(m=>m!==rm);
        Object.values(s.networks).forEach(obj=>{ delete obj[rm]; });
        renderMetricPills(); renderSocialTables(); renderSocialSelectors(); renderSocialChart();
      };
    }
    function renderSocialTables(){
      const s=curData();
      const wrap=$("#socialTables"); wrap.innerHTML="";
      Object.keys(s.networks).forEach(net=>{
        const card=document.createElement('div'); card.className="card col-6";
        const rows=s.metrics.map(mm=>`
          <tr data-mm="${mm}">
            <td class="row-label">${mm}</td>
            <td><input class="num" data-w="0"/></td><td><input class="num" data-w="1"/></td><td><input class="num" data-w="2"/></td><td><input class="num" data-w="3"/></td><td><input class="num" data-w="4"/></td>
            <td class="total"></td>
          </tr>`).join('')
          + (s.metrics.includes("Cliques") && s.metrics.includes("Impressões") ? `
          <tr data-mm="CTR">
            <td class="row-label">CTR (%)</td>
            <td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td><td><input class="num" readonly/></td>
            <td class="total"></td>
          </tr>` : ``);
        card.innerHTML=`<h3>${net}</h3>
          <table class="wk" data-net="${net}">
            <thead><tr><th>Métrica</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>Total</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
        wrap.appendChild(card);

        // preencher valores
        const tbl=card.querySelector("table");
        s.metrics.forEach(mm=>{
          const tr=[...tbl.tBodies[0].rows].find(r=>r.dataset.mm===mm);
          if(!tr) return;
          [...tr.querySelectorAll("input.num[data-w]")].forEach(inp=>{
            const i=+inp.dataset.w; inp.value = s.networks[net][mm][i] ?? 0;
          });
          tr.querySelector(".total").textContent = sum(s.networks[net][mm]).toLocaleString('pt-BR');
        });
        // CTR preenchido
        if (s.metrics.includes("Cliques") && s.metrics.includes("Impressões")) {
          const ctrTr=[...tbl.tBodies[0].rows].find(r=>r.dataset.mm==="CTR");
          if (ctrTr){
            const ctrArr=Array.from({length:5},(_,i)=>calcCTR(num(s.networks[net]["Cliques"][i]||0), num(s.networks[net]["Impressões"][i]||0)));
            [...ctrTr.querySelectorAll("input")].forEach((inp,i)=> inp.value = ctrArr[i].toFixed(2));
            ctrTr.querySelector(".total").textContent=(sum(ctrArr)/5).toFixed(2)+" %";
          }
        }
      });

      // Delegação de input — NÃO re-renderiza a tabela (mantém foco)
      $("#socialTables").oninput = e=>{
        const inp=e.target.closest("input.num[data-w]");
        if(!inp) return;
        const tbl=inp.closest("table"); const net=tbl.dataset.net;
        const tr=inp.closest("tr"); const mm=tr.dataset.mm;
        if(mm==="CTR") return; // derivado
        const i=+inp.dataset.w; const v=num(inp.value);
        const s=curData();
        s.networks[net][mm][i]=v;

        // atualizar total da linha
        tr.querySelector(".total").textContent = sum(s.networks[net][mm]).toLocaleString('pt-BR');

        // atualizar CTR se necessário
        if ((mm==="Cliques" || mm==="Impressões") && s.metrics.includes("Cliques") && s.metrics.includes("Impressões")){
          const ctrTr=[...tbl.tBodies[0].rows].find(r=>r.dataset.mm==="CTR");
          if(ctrTr){
            const ctrArr=Array.from({length:5},(_,k)=>calcCTR(num(s.networks[net]["Cliques"][k]||0), num(s.networks[net]["Impressões"][k]||0)));
            [...ctrTr.querySelectorAll("input")].forEach((inp2,k)=> inp2.value = ctrArr[k].toFixed(2));
            ctrTr.querySelector(".total").textContent=(sum(ctrArr)/5).toFixed(2)+" %";
          }
        }
        renderSocialChart(); // atualiza gráfico sem perder foco
      };
    }
    function renderSocialSelectors(){
      const s=curData();
      const selNet=$("#selNet"), selMetric=$("#selMetric");
      selNet.innerHTML=Object.keys(s.networks).map(n=>`<option>${n}</option>`).join('');
      selMetric.innerHTML=s.metrics.map(mm=>`<option>${mm}</option>`).join('');
      if (!selNet.value && Object.keys(s.networks).length) selNet.value = Object.keys(s.networks)[0];
      if (!selMetric.value && s.metrics.length) selMetric.value = s.metrics[0];
      selNet.onchange=renderSocialChart; selMetric.onchange=renderSocialChart;
    }

    /* ========================= DASH/CHARTS ==================== */
    let chartInvest, chartCPL, chartCPO, chartLeadOpp, chartAware, chartAnnual, chartLeadPlan, chartSocial;
    function makeOrUpdate(ref, canvas, type, data, options){
      if(ref && ref instanceof Chart){ ref.data=data; ref.options=options||{}; ref.update(); return ref; }
      return new Chart(canvas, {type, data, options});
    }

    function renderChartsAndKpis(updateAnnualToo=true){
      if(STATE.segment==="Redes Sociais"){ return; }
      const m=curData();

      // KPI bar
      const investWeekly=Array.from({length:5},(_,i)=> num(m.paid.meta.investimento[i]) + num(m.paid.google.investimento[i]) );
      const investMonth=sum(investWeekly);
      const leadsMonth=sum(computeAutoLeads(m));
      const oppMonth=sum(m.pipe.oportunidades);
      const salesMonth=sum(m.pipe.vendas);
      const cacMonth = oppMonth>0 ? investMonth/oppMonth : 0;
      $("#kpiInvest").textContent=fmtR(investMonth);
      $("#kpiLeads").textContent=leadsMonth.toLocaleString('pt-BR');
      $("#kpiOpp").textContent=oppMonth.toLocaleString('pt-BR');
      $("#kpiSales").textContent=salesMonth.toLocaleString('pt-BR');
      $("#kpiCAC").textContent=fmtR(cacMonth);

      // Dados p/ gráficos semanais
      const meta=m.paid.meta, goo=m.paid.google;
      const leadsPago=Array.from({length:5},(_,i)=>num(meta.leads[i])+num(goo.leads[i]));
      const oportunidades=m.pipe.oportunidades;
      const CPL=investWeekly.map((inv,i)=> (leadsPago[i]>0)? inv/leadsPago[i]:0);
      const CPO=investWeekly.map((inv,i)=> (num(oportunidades[i])>0)? inv/num(oportunidades[i]):0);

      const paidClick=Array.from({length:5},(_,i)=>num(meta.cliques[i])+num(goo.cliques[i]));
      const paidImpr=Array.from({length:5},(_,i)=>num(meta.impressoes[i])+num(goo.impressoes[i]));
      const paidReach=Array.from({length:5},(_,i)=>num(meta.alcance[i])+num(goo.alcance[i]));
      const paidSess=Array.from({length:5},(_,i)=>num(meta.sessoes[i])+num(goo.sessoes[i]));
      const paidCTR=paidClick.map((c,i)=>calcCTR(c,paidImpr[i]));

      // Investimento: visões
      const view=$("#investView").value;
      let investDataSets=[];
      if(view==="total"){
        investDataSets=[{label:"Investimento (Meta+Google)", data:investWeekly, borderWidth:1}];
      }else if(view==="separado"){
        investDataSets=[
          {label:"Meta", data:meta.investimento, borderWidth:1},
          {label:"Google", data:goo.investimento, borderWidth:1}
        ];
      }else if(view==="meta"){
        investDataSets=[{label:"Meta", data:meta.investimento, borderWidth:1}];
      }else{
        investDataSets=[{label:"Google", data:goo.investimento, borderWidth:1}];
      }

      chartInvest = makeOrUpdate(chartInvest, $("#chartInvest"), 'bar', {labels:weekLabels(), datasets:investDataSets}, {responsive:true, scales:{y:{beginAtZero:true}}});
      chartCPL    = makeOrUpdate(chartCPL, $("#chartCPL"), 'line', {labels:weekLabels(), datasets:[{label:"CPL (R$)", data:CPL, tension:.25}]}, {responsive:true, scales:{y:{beginAtZero:true}}});
      chartCPO    = makeOrUpdate(chartCPO, $("#chartCPO"), 'line', {labels:weekLabels(), datasets:[{label:"CPO (R$)", data:CPO, tension:.25}]}, {responsive:true, scales:{y:{beginAtZero:true}}});
      chartLeadOpp= makeOrUpdate(chartLeadOpp, $("#chartLeadOpp"), 'scatter', {datasets:[{label:"Semanas", data:Array.from({length:5},(_,i)=>({x:num(m.pipe.leads[i]), y:num(oportunidades[i])})), pointRadius:5}]},{responsive:true, scales:{x:{title:{display:true,text:"Leads"},beginAtZero:true}, y:{title:{display:true,text:"Oportunidades"},beginAtZero:true}}});
      chartAware  = makeOrUpdate(chartAware, $("#chartAware"), 'line', {labels:weekLabels(), datasets:[
        {label:"Alcance (pago)", data:paidReach, tension:.25},
        {label:"Impressões (pago)", data:paidImpr, tension:.25},
        {label:"Cliques (pago)", data:paidClick, tension:.25},
        {label:"Sessões (pago)", data:paidSess, tension:.25},
        {label:"CTR (%)", data:paidCTR, tension:.25, yAxisID:'y1'}
      ]},{responsive:true, scales:{y:{beginAtZero:true}, y1:{position:'right', beginAtZero:true}}});

      // Leads Planejados x Conquistados
      const mode=$("#leadPlanView").value;
      let ds=[];
      if(mode==="ambos"){
        ds=[
          {label:"Meta — Planejado", data:meta.leadsPlan, tension:.25},
          {label:"Meta — Conquistado", data:meta.leads, tension:.25},
          {label:"Google — Planejado", data:goo.leadsPlan, tension:.25},
          {label:"Google — Conquistado", data:goo.leads, tension:.25},
        ];
      }else if(mode==="meta"){
        ds=[
          {label:"Meta — Planejado", data:meta.leadsPlan, tension:.25},
          {label:"Meta — Conquistado", data:meta.leads, tension:.25},
        ];
      }else{
        ds=[
          {label:"Google — Planejado", data:goo.leadsPlan, tension:.25},
          {label:"Google — Conquistado", data:goo.leads, tension:.25},
        ];
      }
      chartLeadPlan = makeOrUpdate(chartLeadPlan, $("#chartLeadPlan"), 'line', {labels:weekLabels(), datasets:ds}, {responsive:true, scales:{y:{beginAtZero:true}}});

      if(updateAnnualToo) renderAnnual();
    }

    function renderAnnual(){
      if(STATE.mode!=="annual"){ $("#weeklyDash").style.display=""; $("#annualDash").style.display="none"; return; }
      $("#weeklyDash").style.display="none"; $("#annualDash").style.display="";
      const months=STATE.data[STATE.segment][STATE.year];

      // Recalcular a partir dos inputs (independente do pipeline salvo)
      const alc=months.map(m => sum(m.paid.meta.alcance.map((v,i)=> num(v)+num(m.paid.google.alcance[i]))));
      const cliques=months.map(m => sum(m.paid.meta.cliques.map((v,i)=> num(v)+num(m.paid.google.cliques[i]))));
      const leads=months.map(m => {
        const org = (()=>{ let w=[0,0,0,0,0]; Object.values(m.organic.sources).forEach(a=>a.forEach((v,i)=>w[i]+=num(v))); Object.values(m.organic.landing).forEach(a=>a.forEach((v,i)=>w[i]+=num(v))); return w; })();
        const paid=[0,0,0,0,0]; for(let i=0;i<5;i++) paid[i]=num(m.paid.meta.leads[i])+num(m.paid.google.leads[i]);
        return sum(org.map((v,i)=>v+paid[i]));
      });
      const opp=months.map(m => sum(m.pipe.oportunidades));
      const vendas=months.map(m => sum(m.pipe.vendas));

      chartAnnual = makeOrUpdate(chartAnnual,$("#chartAnnual"),'line',{labels:MONTHS,datasets:[
        {label:"Awareness (Alcance pago)", data:alc, tension:.25},
        {label:"Cliques (pago)", data:cliques, tension:.25},
        {label:"Leads (total)", data:leads, tension:.25},
        {label:"Oportunidade", data:opp, tension:.25},
        {label:"Vendas", data:vendas, tension:.25},
      ]},{responsive:true, scales:{y:{beginAtZero:true}}});
    }

    /* ========================= SOCIAL CHART =================== */
    function renderSocialChart(){
      if(STATE.segment!=="Redes Sociais") return;
      const s=curData();
      const n=$("#selNet").value || Object.keys(s.networks)[0];
      const mm=$("#selMetric").value || s.metrics[0];
      let arr = (mm==="CTR")
        ? Array.from({length:5},(_,i)=>calcCTR(num(s.networks[n]["Cliques"]?.[i]??0), num(s.networks[n]["Impressões"]?.[i]??0)))
        : (s.networks[n][mm]??zeros5());
      chartSocial = makeOrUpdate(chartSocial, $("#chartSocial"), 'line', {labels:weekLabels(), datasets:[{label:`${n} — ${mm}`, data:arr, tension:.25}]}, {responsive:true, scales:{y:{beginAtZero:true}}});
    }

    /* ========================= CONTROLES TOPO ================= */
    $("#yearSelect").onchange=e=>{ STATE.year=parseInt(e.target.value,10); renderAll(); };
    $("#monthSelect").onchange=e=>{ STATE.month=parseInt(e.target.value,10); renderAll(); };
    $("#modeToggle").onchange=e=>{ STATE.mode=e.target.checked?"annual":"weekly"; renderChartsAndKpis(); };
    $("#investView").onchange=()=> renderChartsAndKpis();
    $("#leadPlanView").onchange=()=> renderChartsAndKpis();

    // Import/Export
    $("#importBtn").onclick=()=>$("#fileInput").click();
    $("#fileInput").onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const o=JSON.parse(r.result);
          if(o?.data){
            SEGMENTS.forEach(seg=>{
              if(o.data[seg]){
                YEARS.forEach(y=>{
                  if(o.data[seg][y]) STATE.data[seg][y]=o.data[seg][y];
                });
              }
            });
            if(o.year && YEARS.includes(o.year)) { STATE.year=o.year; $("#yearSelect").value=String(o.year); }
            if(typeof o.month==="number") { STATE.month=Math.max(0,Math.min(11,o.month)); $("#monthSelect").value=String(STATE.month); }
            if(o.segment && SEGMENTS.includes(o.segment)) {
              STATE.segment=o.segment;
              $$(".seg-tab").forEach(x=>x.classList.toggle('active', x.dataset.seg===STATE.segment));
            }
          }
          toggleAreas(); renderAll();
        }catch(_){ alert("JSON inválido."); }
      };
      r.readAsText(f); e.target.value="";
    };
    $("#exportBtn").onclick=()=>{
      const blob=new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`camerite-dashboard-${STATE.year}.json`; a.click(); URL.revokeObjectURL(a.href);
    };

    /* ========================= RENDER ROOT ==================== */
    function renderAll(){
      if(!monthEnabled()){
        $$(".num").forEach(n=>{ n.disabled=true; });
        return;
      } else {
        $$(".num").forEach(n=>{ if(!n.hasAttribute('readonly')) n.disabled=false; });
      }
      if(STATE.segment==="Redes Sociais"){
        renderSocial();
        return;
      }
      renderOrganic();
      renderPaid();
      fillPipeTable();
      renderChartsAndKpis();
    }

    // init
    toggleAreas();
    renderAll();

    // somente scroll vertical
    window.addEventListener('load',()=>{
      document.documentElement.style.overflowX='hidden';
      document.body.style.overflowX='hidden';
    });
  </script>
</body>
</html>
