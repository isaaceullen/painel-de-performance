<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camerite • Performance Semanal/Mensal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --camerite-primary:#7B48EA;
    --camerite-dark:#29184E;
    --camerite-soft:#D3C2F8;
    --camerite-white:#FFFFFF;
    --bg-1:#0f0b1f;
    --bg-2:#1b1140;
    --text-1:#F7F7FB;
    --text-2:#CFCFE6;
    --ok:#5CE6AC;
    --warn:#FFE466;
    --err:#FF7373;
    --muted:#4A4270;
    --card:#1c1538;
    --card-2:#221a47;
    --border:#2f245f;
    --shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text-1);
    background:
      radial-gradient(1200px 600px at 80% -10%, rgba(123,72,234,.35), transparent 60%),
      radial-gradient(1000px 600px at -10% 110%, rgba(211,194,248,.25), transparent 60%),
      linear-gradient(180deg, var(--bg-2), var(--bg-1) 60%);
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter:saturate(140%) blur(6px);
    background:rgba(17,10,40,.6);
    border-bottom:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:16px 20px}
  .brand{
    display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:.3px
  }
  .badge{padding:2px 8px;border-radius:20px;background:linear-gradient(135deg,var(--camerite-primary),#52309C);font-size:12px}
  .controls{display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:10px;margin-top:10px}
  select, input[type="number"], input[type="text"]{
    width:100%;padding:10px 12px;border-radius:12px;background:var(--card);
    color:var(--text-1);border:1px solid var(--border);outline:none
  }
  .container{max-width:1200px;margin:24px auto;padding:0 20px 60px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1.2fr .8fr}
  @media (max-width:1100px){.grid.cols-2{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg, var(--card-2), var(--card));
    border:1px solid var(--border);
    border-radius:18px;padding:16px;box-shadow:var(--shadow)
  }
  .card h3{margin:0 0 10px 0;font-size:16px;color:#EDEDF9}
  .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
  @media (max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{
    background:linear-gradient(180deg, #2a1d5a, #211648);
    border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:6px
  }
  .kpi small{color:var(--text-2)}
  .kpi b{font-size:22px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
  .tab-btn{
    padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:#1f1646;color:var(--text-2);
    cursor:pointer
  }
  .tab-btn.active{background:linear-gradient(135deg,var(--camerite-primary),#52309C);color:white;border-color:transparent}
  .tab{display:none}
  .tab.active{display:block}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .btn{
    appearance:none;border:1px solid var(--border);background:#20174a;color:var(--text-1);
    padding:10px 14px;border-radius:12px;cursor:pointer
  }
  .btn.primary{background:linear-gradient(135deg,var(--camerite-primary),#52309C);border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.danger{background:#3a1730;border-color:#6a254d}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th, td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:right}
  th:first-child, td:first-child{text-align:left}
  thead th{position:sticky;top:0;background:#1c1538}
  .muted{color:var(--text-2)}
  .group-title{margin-top:18px;font-weight:700}
  .pill{background:#2b2157;border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:var(--text-2);font-size:12px}
  .row-controls{display:flex;gap:6px}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .note{font-size:12px;color:var(--text-2)}
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px}
  .danger-text{color:#ff8ba1}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <span style="width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--camerite-primary),#52309C);display:inline-block"></span>
      <span>Camerite • <span class="muted">Painel de Performance</span></span>
      <span class="badge">Beta</span>
    </div>

    <div class="controls">
      <select id="segment">
        <option value="white-label">White Label</option>
        <option value="franquias">Franquias</option>
      </select>
      <select id="year"></select>
      <select id="month"></select>
      <div class="inline">
        <input id="weeks" type="number" min="1" max="6" value="4" />
      </div>
      <button class="btn" id="saveBtn">Salvar (local)</button>
      <div class="inline" style="justify-content:flex-end">
        <button class="btn ghost" id="importBtn">Importar JSON</button>
        <button class="btn ghost" id="exportBtn">Exportar JSON</button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="grid cols-2">
    <div class="card">
      <h3>KPIs do Mês Selecionado</h3>
      <div class="kpis" id="kpiGrid">
        <!-- KPIs preenchidos via JS -->
      </div>
    </div>
    <div class="card">
      <h3>Visão Rápida</h3>
      <div class="flex">
        <span class="pill" id="pill-segment">Segmento</span>
        <span class="pill" id="pill-periodo">Período</span>
        <span class="pill">Semanas: <b id="pill-weeks">4</b></span>
      </div>
      <p class="note" style="margin-top:10px">
        • CPL = Investimento ÷ Leads (pago) • CAC = Total investido (Meta + Google) ÷ Vendas •
        Valores e linhas totais são calculados automaticamente. 
      </p>
    </div>
  </section>

  <section class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="tabela">Tabela</button>
      <button class="tab-btn" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="sociais">Redes Sociais</button>
      <button class="tab-btn" data-tab="ajuda">Ajuda</button>
    </div>

    <!-- TABELA -->
    <div class="tab active" id="tabela">
      <!-- ORGÂNICO -->
      <h3 class="group-title">Orgânico</h3>
      <div class="inline" style="margin:6px 0 8px 0">
        <button class="btn" id="addOrganicSource">+ Adicionar origem</button>
        <span class="note">Ex.: Bing, Google, Link na Bio, Tallos…</span>
      </div>
      <div id="organicTableWrap"></div>

      <!-- SITE + LANDING PAGES -->
      <div class="flex" style="margin-top:16px">
        <div style="flex:1">
          <h3 class="group-title">Site</h3>
          <div class="inline" style="margin:6px 0 8px 0">
            <button class="btn" id="addSiteSub">+ Adicionar origem do site</button>
            <span class="note">Ex.: contato-site…</span>
          </div>
          <div id="siteTableWrap"></div>
        </div>
        <div style="flex:1">
          <h3 class="group-title">Landing Pages</h3>
          <div class="inline" style="margin:6px 0 8px 0">
            <button class="btn" id="addLpSub">+ Adicionar landing</button>
            <span class="note">Ex.: white-label, newsletter, outros…</span>
          </div>
          <div id="lpTableWrap"></div>
        </div>
      </div>

      <!-- TOTAL / AWARENESS / ENGAJAMENTO ORGÂNICO -->
      <div id="organicMetaWrap" style="margin-top:14px"></div>

      <hr style="border:0;border-top:1px solid var(--border);margin:22px 0">

      <!-- PAGO -->
      <h3 class="group-title">Pago</h3>
      <div id="paidWrap"></div>

      <div id="paidMetaWrap" style="margin-top:14px"></div>

      <hr style="border:0;border-top:1px solid var(--border);margin:22px 0">

      <!-- PIPELINE -->
      <h3 class="group-title">Pipeline Comercial</h3>
      <div id="pipelineWrap"></div>

      <div class="footer-actions">
        <button class="btn danger" id="clearMonth">Limpar mês</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="tab" id="dashboard">
      <div class="grid">
        <div class="card">
          <h3>Evolução semanal — Leads (Orgânico x Pago)</h3>
          <canvas id="chartLeads"></canvas>
        </div>
        <div class="card">
          <h3>Investimento semanal — Meta + Google</h3>
          <canvas id="chartInvest"></canvas>
        </div>
        <div class="card">
          <h3>CPL semanal (pago)</h3>
          <canvas id="chartCPL"></canvas>
        </div>
        <div class="card">
          <h3>Distribuição mensal de Leads (por origem orgânica)</h3>
          <canvas id="chartPieOrganic"></canvas>
        </div>
        <div class="card">
          <h3>Awareness & Engajamento — Totais Semanais (pago)</h3>
          <canvas id="chartAwEng"></canvas>
        </div>
      </div>
    </div>

    <!-- REDES SOCIAIS -->
    <div class="tab" id="sociais">
      <div class="inline" style="margin:6px 0 8px 0">
        <button class="btn" id="addSocial">+ Adicionar rede</button>
        <span class="note">Ex.: Instagram, LinkedIn, YouTube…</span>
      </div>
      <div id="socialsWrap"></div>
    </div>

    <!-- AJUDA -->
    <div class="tab" id="ajuda">
      <div class="grid">
        <div class="kpi">
          <small>Como salvar</small>
          <b>Salvar (local)</b>
          <small class="muted">Grava no seu navegador; use “Exportar JSON” para backup e versionamento no Git.</small>
        </div>
        <div class="kpi">
          <small>Importar</small>
          <b>Importar JSON</b>
          <small class="muted">Carrega um arquivo salvo anteriormente (mesma estrutura de dados).</small>
        </div>
      </div>
      <p class="note" style="margin-top:10px">
        Dica: mantenha **White Label** e **Franquias** atualizados separadamente e exporte um JSON por mês/ano para versionar no repositório.
      </p>
    </div>
  </section>
</main>

<input type="file" id="fileInput" accept="application/json" style="display:none"/>

<script>
/* =============== UTIL ================== */
const currency = (v) => {
  if (v === null || v === undefined || isNaN(v)) return "R$ 0,00";
  return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
};
const num = (v) => Number(v ?? 0) || 0;
const id = (s) => document.getElementById(s);
const weeksLabels = (n) => Array.from({length:n}, (_,i)=>`S${i+1}`);

/* =============== ESTADO =============== */
const INITIAL_SOURCES = ["Bing","Google","Link na Bio","Tallos"];
const INITIAL_SITE = ["contato-site"];
const INITIAL_LPS = ["white-label","newsletter","outros"];
const YEAR_NOW = new Date().getFullYear();

const state = {
  segment: 'white-label',
  year: YEAR_NOW,
  month: new Date().getMonth(), // 0-11
  weeks: 4,
  data: {} // [segment][year][month] -> payload
};

function ensureMonth(){
  const {segment,year,month,weeks} = state;
  state.data[segment] ??= {};
  state.data[segment][year] ??= {};
  if(!state.data[segment][year][month]){
    // cria payload vazio
    const emptyWeeks = Array.from({length:weeks},()=>0);
    const makeWeeklyObj = (name)=>({name, weeks: Array.from({length:weeks},()=>0)});
    const organic = {
      sources: INITIAL_SOURCES.map(s=>makeWeeklyObj(s)),
      site: INITIAL_SITE.map(s=>makeWeeklyObj(s)),
      lps: INITIAL_LPS.map(s=>makeWeeklyObj(s)),
      awareness: { weeks:[...emptyWeeks] },
      engagement:{ weeks:[...emptyWeeks] },
    };
    const paidGroup = ()=>({
      leads:{weeks:[...emptyWeeks]},
      leadsPlan:{weeks:[...emptyWeeks]},
      invest:{weeks:[...emptyWeeks]}
    });
    const paid = {
      meta: paidGroup(),
      google: paidGroup(),
      awareness:{weeks:[...emptyWeeks]},
      engagement:{weeks:[...emptyWeeks]},
    };
    const pipeline = {
      agendamentos:{weeks:[...emptyWeeks]},
      reunioes:{weeks:[...emptyWeeks]},
      noShow:{weeks:[...emptyWeeks]},
      vendas:{weeks:[...emptyWeeks]},
      perdidos:{weeks:[...emptyWeeks]},
      // opcionais
      oportunidades:{weeks:[...emptyWeeks]},
    };
    const socials = {
      networks: [
        {name:"Instagram", metrics:{
          visitas:{weeks:[...emptyWeeks]},
          likes:{weeks:[...emptyWeeks]},
          comentarios:{weeks:[...emptyWeeks]},
          compartilhamentos:{weeks:[...emptyWeeks]},
        }},
      ]
    };
    state.data[segment][year][month] = {weeks, organic, paid, pipeline, socials};
  }else{
    // se semanas mudaram, ajusta arrays
    const payload = state.data[segment][year][month];
    if(payload.weeks !== weeks){
      const resize = (arr)=> {
        const copy = [...arr];
        if(weeks > copy.length)
          return copy.concat(Array.from({length:weeks-copy.length},()=>0));
        else
          return copy.slice(0,weeks);
      };
      const eachWeekly = [];
      // Organic
      payload.organic.sources.forEach(o=>{o.weeks=resize(o.weeks)});
      payload.organic.site.forEach(o=>{o.weeks=resize(o.weeks)});
      payload.organic.lps.forEach(o=>{o.weeks=resize(o.weeks)});
      payload.organic.awareness.weeks = resize(payload.organic.awareness.weeks);
      payload.organic.engagement.weeks = resize(payload.organic.engagement.weeks);
      // Paid
      ["meta","google"].forEach(k=>{
        payload.paid[k].leads.weeks = resize(payload.paid[k].leads.weeks);
        payload.paid[k].leadsPlan.weeks = resize(payload.paid[k].leadsPlan.weeks);
        payload.paid[k].invest.weeks = resize(payload.paid[k].invest.weeks);
      });
      payload.paid.awareness.weeks = resize(payload.paid.awareness.weeks);
      payload.paid.engagement.weeks = resize(payload.paid.engagement.weeks);
      // Pipeline
      Object.values(payload.pipeline).forEach(obj=>{obj.weeks=resize(obj.weeks)});
      // Socials
      payload.socials.networks.forEach(net=>{
        Object.values(net.metrics).forEach(m=> m.weeks = resize(m.weeks));
      });
      payload.weeks = weeks;
    }
  }
  return state.data[segment][year][month];
}

/* =============== RENDER =============== */
function renderAll(){
  const payload = ensureMonth();
  id('pill-segment').textContent = (state.segment==='white-label'?'White Label':'Franquias');
  id('pill-periodo').textContent = `${MONTHS[state.month]} / ${state.year}`;
  id('pill-weeks').textContent = payload.weeks;

  renderOrganicTables(payload);
  renderPaid(payload);
  renderPipeline(payload);
  renderKPIs(payload);
  renderSocials(payload);
  renderCharts(payload);
}

const MONTHS = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

function sum(arr){return arr.reduce((a,b)=>a+num(b),0)}
function tableWeeklyHeader(n, extra=[]) {
  const th = weeksLabels(n).map(l=>`<th>${l}</th>`).join('');
  const extraTh = extra.map(x=>`<th>${x}</th>`).join('');
  return `<thead><tr><th>Origem</th>${th}<th>Total</th>${extraTh}<th></th></tr></thead>`;
}
function rowNumberInputs(weeks, arr, onChange){
  return weeksLabels(weeks).map((_,i)=>`
    <td><input type="number" step="1" min="0" value="${num(arr[i])}" 
      oninput="${onChange}(this, ${i})" style="width:100%;background:#180f3a;border:1px solid var(--border);border-radius:8px;padding:6px;color:var(--text-1)"></td>
  `).join('');
}
function renderListTable({title, list, containerId, weeks, onChangeName, onChangeWeek, onAdd, onRemove}){
  const wrap = id(containerId);
  const header = tableWeeklyHeader(weeks);
  const rows = list.map((o,idx)=>`
    <tr>
      <td>
        <div class="row-controls">
          <input type="text" value="${o.name}" oninput="${onChangeName}(this, ${idx})"
            style="width:100%;background:#180f3a;border:1px solid var(--border);border-radius:8px;padding:6px;color:var(--text-1)">
        </div>
      </td>
      ${rowNumberInputs(weeks, o.weeks, `${onChangeWeek}.bind(null, ${idx})`)}
      <td class="muted"><b>${sum(o.weeks)}</b></td>
      <td style="text-align:right"><button class="btn danger" onclick="${onRemove}(${idx})">Remover</button></td>
    </tr>
  `).join('');
  wrap.innerHTML = `
    <div class="card">
      <table>${header}<tbody>${rows || ''}</tbody></table>
      <div class="footer-actions"><button class="btn" onclick="${onAdd}()">+ Adicionar linha</button></div>
    </div>
  `;
}

function renderOrganicTables(payload){
  // orgânico livres
  renderListTable({
    title:"Orgânico",
    list: payload.organic.sources,
    containerId:"organicTableWrap",
    weeks: payload.weeks,
    onChangeName:"onOrganicName",
    onChangeWeek:"onOrganicWeek",
    onAdd:"onOrganicAdd",
    onRemove:"onOrganicRemove"
  });
  // site
  renderListTable({
    title:"Site",
    list: payload.organic.site,
    containerId:"siteTableWrap",
    weeks: payload.weeks,
    onChangeName:"onSiteName",
    onChangeWeek:"onSiteWeek",
    onAdd:"onSiteAdd",
    onRemove:"onSiteRemove"
  });
  // lps
  renderListTable({
    title:"LPs",
    list: payload.organic.lps,
    containerId:"lpTableWrap",
    weeks: payload.weeks,
    onChangeName:"onLpName",
    onChangeWeek:"onLpWeek",
    onAdd:"onLpAdd",
    onRemove:"onLpRemove"
  });

  // Totais / Awareness / Engajamento
  const wrap = id('organicMetaWrap');
  const weeks = payload.weeks;
  const totalSemanal = Array.from({length:weeks},(_,i)=>{
    const sumSources = payload.organic.sources.reduce((a,o)=>a+num(o.weeks[i]),0);
    const sumSite = payload.organic.site.reduce((a,o)=>a+num(o.weeks[i]),0);
    const sumLps = payload.organic.lps.reduce((a,o)=>a+num(o.weeks[i]),0);
    return sumSources + sumSite + sumLps;
  });
  const tableRow = (label, arr, hook)=>`
    <tr>
      <td>${label}</td>
      ${rowNumberInputs(weeks, arr, hook)}
      <td class="muted"><b>${sum(arr)}</b></td>
      <td></td>
    </tr>`;
  wrap.innerHTML = `
    <div class="card">
      <table>${tableWeeklyHeader(weeks)}
        <tbody>
          <tr>
            <td><b>Total (orgânico)</b></td>
            ${totalSemanal.map(v=>`<td class="muted">${v}</td>`).join('')}
            <td class="muted"><b>${sum(totalSemanal)}</b></td>
            <td></td>
          </tr>
          ${tableRow('Awareness (alcance + impressões)', payload.organic.awareness.weeks, 'onOrganicAware')}
          ${tableRow('Engajamento (Cliques, CTR, Sessões)', payload.organic.engagement.weeks, 'onOrganicEng')}
        </tbody>
      </table>
    </div>
  `;
}

/* Paid */
function renderPaid(payload){
  const wrap = id('paidWrap');
  const weeks = payload.weeks;
  const makePaidTable = (label, key)=>{
    const leads = payload.paid[key].leads.weeks;
    const plan = payload.paid[key].leadsPlan.weeks;
    const invest = payload.paid[key].invest.weeks;
    const cpl = leads.map((v,i)=> num(v)>0 ? num(invest[i])/num(v) : 0);
    const row = (title, arr, hook, format='num')=>`
      <tr>
        <td>${title}</td>
        ${weeksLabels(weeks).map((_,i)=>`<td>${
          format==='money'
            ? `<input type="number" step="0.01" value="${num(arr[i])}" oninput="${hook}(this, ${i})" style="width:100%;background:#180f3a;border:1px solid var(--border);border-radius:8px;padding:6px;color:var(--text-1)">`
            : `<input type="number" step="1" min="0" value="${num(arr[i])}" oninput="${hook}(this, ${i})" style="width:100%;background:#180f3a;border:1px solid var(--border);border-radius:8px;padding:6px;color:var(--text-1)">`
        }</td>`).join('')}
        <td class="muted"><b>${sum(arr)}</b></td>
        <td></td>
      </tr>`;
    const cplRow = `
      <tr>
        <td><b>CPL</b></td>
        ${cpl.map(v=>`<td class="muted">${v>0? currency(v): '-'}</td>`).join('')}
        <td class="muted"><b>${sum(leads)>0 ? currency(sum(invest)/sum(leads)):'-'}</b></td>
        <td></td>
      </tr>`;
    return `
      <div class="card">
        <h3>${label}</h3>
        <table>${tableWeeklyHeader(weeks, [])}
          <tbody>
            ${row('Leads', leads, `onPaidLeads.bind(null,'${key}')`)}
            ${row('Leads Plan', plan, `onPaidPlan.bind(null,'${key}')`)}
            ${row('Valor investido (R$)', invest, `onPaidInvest.bind(null,'${key}')`, 'money')}
            ${cplRow}
          </tbody>
        </table>
      </div>
    `;
  };
  wrap.innerHTML = `
    <div class="grid">
      ${makePaidTable('Meta Ads','meta')}
      ${makePaidTable('Google Ads','google')}
    </div>
  `;

  // totals awareness/engagement for paid
  const wrap2 = id('paidMetaWrap');
  const weeksArr = payload.weeks;
  const totalInvestWeekly = Array.from({length:weeksArr},(_,i)=> num(payload.paid.meta.invest.weeks[i]) + num(payload.paid.google.invest.weeks[i]));
  const totalLeadsWeekly = Array.from({length:weeksArr},(_,i)=> num(payload.paid.meta.leads.weeks[i]) + num(payload.paid.google.leads.weeks[i]));
  wrap2.innerHTML = `
    <div class="card">
      <table>${tableWeeklyHeader(weeksArr)}
        <tbody>
          <tr>
            <td><b>Total Leads (pago)</b></td>
            ${totalLeadsWeekly.map(v=>`<td class="muted">${v}</td>`).join('')}
            <td class="muted"><b>${sum(totalLeadsWeekly)}</b></td>
            <td></td>
          </tr>
          <tr>
            <td><b>Total Investido (Meta + Google)</b></td>
            ${totalInvestWeekly.map(v=>`<td class="muted">${currency(v)}</td>`).join('')}
            <td class="muted"><b>${currency(sum(totalInvestWeekly))}</b></td>
            <td></td>
          </tr>
          <tr>
            <td><b>CPL (pago)</b></td>
            ${totalLeadsWeekly.map((v,i)=> v>0 ? `<td class="muted">${currency(totalInvestWeekly[i]/v)}</td>` : `<td class="muted">-</td>`).join('')}
            <td class="muted"><b>${sum(totalLeadsWeekly)>0 ? currency(sum(totalInvestWeekly)/sum(totalLeadsWeekly)):'-'}</b></td>
            <td></td>
          </tr>
          <tr>
            <td>Awareness (alcance + impressões)</td>
            ${rowNumberInputs(weeksArr, payload.paid.awareness.weeks, 'onPaidAware')}
            <td class="muted"><b>${sum(payload.paid.awareness.weeks)}</b></td>
            <td></td>
          </tr>
          <tr>
            <td>Engajamento (Cliques, CTR, Sessões)</td>
            ${rowNumberInputs(weeksArr, payload.paid.engagement.weeks, 'onPaidEng')}
            <td class="muted"><b>${sum(payload.paid.engagement.weeks)}</b></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

/* Pipeline */
function renderPipeline(payload){
  const wrap = id('pipelineWrap');
  const weeks = payload.weeks;
  const header = tableWeeklyHeader(weeks, []);
  const row = (label, key)=>`
    <tr>
      <td>${label}</td>
      ${rowNumberInputs(weeks, payload.pipeline[key].weeks, `onPipeline.bind(null,'${key}')`)}
      <td class="muted"><b>${sum(payload.pipeline[key].weeks)}</b></td>
      <td></td>
    </tr>`;
  const vendasTot = sum(payload.pipeline.vendas.weeks);
  const investTot = sum(payload.paid.meta.invest.weeks) + sum(payload.paid.google.invest.weeks);
  const cac = vendasTot>0 ? investTot / vendasTot : 0;

  wrap.innerHTML = `
    <div class="card">
      <table>${header}
        <tbody>
          ${row('Agendamentos','agendamentos')}
          ${row('Reuniões realizadas','reunioes')}
          ${row('No show','noShow')}
          ${row('Vendas','vendas')}
          ${row('Perdidos','perdidos')}
        </tbody>
      </table>
      <div class="inline" style="margin-top:10px">
        <span class="pill">Investimento no mês: <b>${currency(investTot)}</b></span>
        <span class="pill">Vendas no mês: <b>${vendasTot}</b></span>
        <span class="pill">CAC: <b>${vendasTot>0?currency(cac):'-'}</b></span>
      </div>
    </div>
  `;
}

/* KPIs */
function renderKPIs(payload){
  const leadsPaid = sum(payload.paid.meta.leads.weeks) + sum(payload.paid.google.leads.weeks);
  const invest = sum(payload.paid.meta.invest.weeks) + sum(payload.paid.google.invest.weeks);
  const cpl = leadsPaid>0 ? invest/leadsPaid : 0;

  const vendas = sum(payload.pipeline.vendas.weeks);
  const cac = vendas>0 ? invest/vendas : 0;

  const leadsOrganic = sum(payload.organic.sources.flatMap(x=>x.weeks)) + 
                       sum(payload.organic.site.flatMap(x=>x.weeks)) + 
                       sum(payload.organic.lps.flatMap(x=>x.weeks));

  const reunioes = sum(payload.pipeline.reunioes.weeks);
  const agend = sum(payload.pipeline.agendamentos.weeks);
  const showRate = agend>0 ? (reunioes/agend)*100 : 0;

  id('kpiGrid').innerHTML = `
    <div class="kpi"><small>Leads — Pago</small><b>${leadsPaid}</b><small class="muted">Meta + Google</small></div>
    <div class="kpi"><small>Investimento</small><b>${currency(invest)}</b><small class="muted">Mês selecionado</small></div>
    <div class="kpi"><small>CPL (pago)</small><b>${leadsPaid>0?currency(cpl):'-'}</b><small class="muted">Invest ÷ Leads</small></div>
    <div class="kpi"><small>Leads — Orgânico</small><b>${leadsOrganic}</b><small class="muted">Somatório de origens</small></div>
    <div class="kpi"><small>Vendas</small><b>${vendas}</b><small class="muted">Total no mês</small></div>
    <div class="kpi"><small>CAC</small><b>${vendas>0?currency(cac):'-'}</b><small class="muted">Invest total ÷ Vendas</small></div>
  `;
}

/* Redes Sociais */
function renderSocials(payload){
  const wrap = id('socialsWrap');
  const weeks = payload.weeks;

  const blocks = payload.socials.networks.map((net,idx)=>{
    const metrics = Object.entries(net.metrics);
    const rows = metrics.map(([label, obj])=>`
      <tr>
        <td>${label}</td>
        ${rowNumberInputs(weeks, obj.weeks, `onSocialMetric.bind(null, ${idx}, '${label}')`)}
        <td class="muted"><b>${sum(obj.weeks)}</b></td>
        <td></td>
      </tr>
    `).join('');
    return `
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <h3 style="margin:0">${net.name}</h3>
          <div class="inline">
            <button class="btn" onclick="addMetric(${idx})">+ Métrica</button>
            <button class="btn danger" onclick="removeNetwork(${idx})">Remover rede</button>
          </div>
        </div>
        <table>${tableWeeklyHeader(weeks)}
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }).join('');
  wrap.innerHTML = blocks || `<div class="note">Nenhuma rede adicionada.</div>`;
}

/* =============== CHARTS =============== */
let charts = {};
function destroyCharts(){Object.values(charts).forEach(c=>c.destroy()); charts={};}

function renderCharts(payload){
  destroyCharts();
  const n = payload.weeks;
  const labels = weeksLabels(n);

  const leadsOrgWeekly = Array.from({length:n},(_,i)=>
    sum(payload.organic.sources.map(o=>num(o.weeks[i]))) +
    sum(payload.organic.site.map(o=>num(o.weeks[i]))) +
    sum(payload.organic.lps.map(o=>num(o.weeks[i])))
  );
  const leadsPaidWeekly = Array.from({length:n},(_,i)=>
    num(payload.paid.meta.leads.weeks[i]) + num(payload.paid.google.leads.weeks[i])
  );
  const investWeekly = Array.from({length:n},(_,i)=>
    num(payload.paid.meta.invest.weeks[i]) + num(payload.paid.google.invest.weeks[i])
  );
  const cplWeekly = labels.map((_,i)=> leadsPaidWeekly[i]>0 ? investWeekly[i]/leadsPaidWeekly[i] : 0);
  const awWeekly = payload.paid.awareness.weeks.map(num);
  const engWeekly = payload.paid.engagement.weeks.map(num);

  charts.leads = new Chart(id('chartLeads'), {
    type:'line',
    data:{labels, datasets:[
      {label:'Orgânico', data:leadsOrgWeekly},
      {label:'Pago', data:leadsPaidWeekly},
    ]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });

  charts.invest = new Chart(id('chartInvest'), {
    type:'bar',
    data:{labels, datasets:[{label:'Investimento (R$)', data:investWeekly}]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });

  charts.cpl = new Chart(id('chartCPL'), {
    type:'line',
    data:{labels, datasets:[{label:'CPL (R$)', data:cplWeekly}]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });

  // pizza orgânico por origem (total do mês)
  const orgTotals = {};
  [...payload.organic.sources, ...payload.organic.site, ...payload.organic.lps].forEach(o=>{
    orgTotals[o.name]=(orgTotals[o.name]||0)+sum(o.weeks);
  });
  const pieLabels = Object.keys(orgTotals);
  const pieData = Object.values(orgTotals);
  charts.pie = new Chart(id('chartPieOrganic'), {
    type:'pie',
    data:{labels: pieLabels, datasets:[{data: pieData}]},
    options:{responsive:true}
  });

  charts.aweng = new Chart(id('chartAwEng'), {
    type:'bar',
    data:{labels, datasets:[
      {label:'Awareness', data:awWeekly, stack:'a'},
      {label:'Engajamento', data:engWeekly, stack:'a'},
    ]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}

/* =============== HANDLERS =============== */
// ORGÂNICO
function onOrganicAdd(){
  const p = ensureMonth(); p.organic.sources.push({name:"Nova origem", weeks:Array.from({length:p.weeks},()=>0)}); renderAll();
}
function onOrganicRemove(idx){const p=ensureMonth(); p.organic.sources.splice(idx,1); renderAll();}
function onOrganicName(el, idx){const p=ensureMonth(); p.organic.sources[idx].name = el.value;}
function onOrganicWeek(idx, el, w){const p=ensureMonth(); p.organic.sources[idx].weeks[w] = num(el.value); renderAll();}

function onSiteAdd(){const p=ensureMonth(); p.organic.site.push({name:"novo-site", weeks:Array.from({length:p.weeks},()=>0)}); renderAll();}
function onSiteRemove(i){const p=ensureMonth(); p.organic.site.splice(i,1); renderAll();}
function onSiteName(el,i){const p=ensureMonth(); p.organic.site[i].name = el.value;}
function onSiteWeek(i,el,w){const p=ensureMonth(); p.organic.site[i].weeks[w]=num(el.value); renderAll();}

function onLpAdd(){const p=ensureMonth(); p.organic.lps.push({name:"nova-lp", weeks:Array.from({length:p.weeks},()=>0)}); renderAll();}
function onLpRemove(i){const p=ensureMonth(); p.organic.lps.splice(i,1); renderAll();}
function onLpName(el,i){const p=ensureMonth(); p.organic.lps[i].name = el.value;}
function onLpWeek(i,el,w){const p=ensureMonth(); p.organic.lps[i].weeks[w]=num(el.value); renderAll();}

function onOrganicAware(el,i){const p=ensureMonth(); p.organic.awareness.weeks[i]=num(el.value); renderAll();}
function onOrganicEng(el,i){const p=ensureMonth(); p.organic.engagement.weeks[i]=num(el.value); renderAll();}

// PAGO
function onPaidLeads(key, el, i){const p=ensureMonth(); p.paid[key].leads.weeks[i]=num(el.value); renderAll();}
function onPaidPlan(key, el, i){const p=ensureMonth(); p.paid[key].leadsPlan.weeks[i]=num(el.value); renderAll();}
function onPaidInvest(key, el, i){const p=ensureMonth(); p.paid[key].invest.weeks[i]=Number(el.value||0); renderAll();}
function onPaidAware(el,i){const p=ensureMonth(); p.paid.awareness.weeks[i]=num(el.value); renderAll();}
function onPaidEng(el,i){const p=ensureMonth(); p.paid.engagement.weeks[i]=num(el.value); renderAll();}

// PIPELINE
function onPipeline(key, el, i){const p=ensureMonth(); p.pipeline[key].weeks[i]=num(el.value); renderAll();}

// SOCIALS
function addMetric(netIdx){
  const p=ensureMonth();
  const name = prompt("Nome da métrica (ex.: visitas, likes, comentários, compartilhamentos):");
  if(!name) return;
  p.socials.networks[netIdx].metrics[name] = {weeks:Array.from({length:p.weeks},()=>0)};
  renderAll();
}
function onSocialMetric(netIdx, metric, el, i){const p=ensureMonth(); p.socials.networks[netIdx].metrics[metric].weeks[i]=num(el.value); renderAll();}
function removeNetwork(idx){const p=ensureMonth(); p.socials.networks.splice(idx,1); renderAll();}
id('addSocial').onclick = ()=>{
  const p=ensureMonth();
  const name = prompt("Nome da rede (ex.: Instagram, LinkedIn, YouTube)");
  if(!name) return;
  p.socials.networks.push({name, metrics:{
    visitas:{weeks:Array.from({length:p.weeks},()=>0)},
    likes:{weeks:Array.from({length:p.weeks},()=>0)},
    comentarios:{weeks:Array.from({length:p.weeks},()=>0)},
    compartilhamentos:{weeks:Array.from({length:p.weeks},()=>0)},
  }});
  renderAll();
};

// Botões “Adicionar”
id('addOrganicSource').onclick = onOrganicAdd;
id('addSiteSub').onclick = onSiteAdd;
id('addLpSub').onclick = onLpAdd;

/* =============== CONTROLES SUPERIORES =============== */
(function initSelectors(){
  // ano
  const ySel = id('year');
  for(let y=YEAR_NOW-1; y<=YEAR_NOW+2; y++){
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if(y===state.year) opt.selected = true;
    ySel.appendChild(opt);
  }
  // mês
  const mSel = id('month');
  MONTHS.forEach((m,i)=>{
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = m;
    if(i===state.month) opt.selected = true;
    mSel.appendChild(opt);
  });
})();
id('segment').onchange = (e)=>{state.segment=e.target.value; ensureMonth(); renderAll(); saveLocal();}
id('year').onchange = (e)=>{state.year=Number(e.target.value); ensureMonth(); renderAll(); saveLocal();}
id('month').onchange = (e)=>{state.month=Number(e.target.value); ensureMonth(); renderAll(); saveLocal();}
id('weeks').oninput = (e)=>{state.weeks=Math.max(1, Math.min(6, Number(e.target.value||4))); ensureMonth(); renderAll(); saveLocal();}

/* =============== TABS =============== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    id(btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab==='dashboard') renderCharts(ensureMonth());
  });
});

/* =============== SALVAR/IMPORTAR/EXPORTAR =============== */
const STORAGE_KEY = 'camerite_performance_v1';
function saveLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    // migração simples
    Object.assign(state, parsed);
  }catch(e){}
}
id('saveBtn').onclick = ()=>{saveLocal(); alert('Dados salvos no navegador.');}
id('exportBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `camerite-${state.segment}-${state.year}-${state.month+1}.json`;
  a.click();
};
id('importBtn').onclick = ()=> id('fileInput').click();
id('fileInput').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{ 
    try{
      const parsed = JSON.parse(reader.result);
      Object.assign(state, parsed);
      // atualizar selects
      id('segment').value = state.segment;
      id('year').value = state.year;
      id('month').value = state.month;
      id('weeks').value = state.weeks;
      renderAll(); saveLocal();
      alert('Importado com sucesso!');
    }catch(err){
      alert('Arquivo inválido.');
    }
  };
  reader.readAsText(file);
});

/* =============== LIMPAR MÊS =============== */
id('clearMonth').onclick = ()=>{
  if(!confirm('Tem certeza que deseja limpar os dados deste mês?')) return;
  const {segment,year,month} = state;
  if(state.data?.[segment]?.[year]) delete state.data[segment][year][month];
  ensureMonth(); renderAll(); saveLocal();
};

/* =============== START =============== */
loadLocal();
ensureMonth();
renderAll();
</script>
</body>
</html>